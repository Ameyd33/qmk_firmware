// Copyright 2023 QMK
// SPDX-License-Identifier: GPL-2.0-or-later

#include QMK_KEYBOARD_H

enum layers {
    _BASE,
    _MEDIA,
    _FN,
    _NUM_LAYERS
};

#define MENU_KEY KC_F24

static bool menu_active = false;
static uint8_t menu_index = _BASE;
static uint8_t current_layer = _BASE;
static uint8_t enc_layer = 0;


#define OLED_ROTATION OLED_ROTATION_0

/*
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

    [_BASE] = LAYOUT_2(
        KC_ESC,  KC_C,    KC_V,    KC_Z,
        KC_LCTL, KC_LALT, KC_LGUI, MO(_MEDIA)
    ),

    [_MEDIA] = LAYOUT_2(
        KC_MUTE, KC_MPRV, KC_MPLY, KC_MNXT,
        _______, _______, _______, MO(_BASE)
    )
};
*/
/* =======================
 * Keymaps (2x4)
 * =======================*/
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

    [_BASE] = LAYOUT_2(
        KC_ESC,  KC_C,    KC_V,    MENU_KEY,
        KC_LCTL, KC_LALT, KC_LGUI, KC_ENT
    ),

    [_MEDIA] = LAYOUT_2(
        KC_MUTE, KC_MPRV, KC_MPLY, MENU_KEY,
        _______, _______, _______, KC_MNXT
    ),

    [_FN] = LAYOUT_2(
        KC_F1,   KC_F2,   KC_F3,   MENU_KEY,
        KC_F4,   KC_F5,   KC_F6,   KC_F7
    )
};

/* =======================
 * MENU key logic
 * =======================*/
bool process_record_user(uint16_t keycode, keyrecord_t *record) {

    if (keycode == MENU_KEY && record->event.pressed) {

        if (!menu_active) {
            // Enter menu
            menu_active = true;
            menu_index = current_layer;
            oled_clear();
        } else {
            // Confirm layer
            menu_active = false;
            current_layer = menu_index;
            layer_move(current_layer);
            oled_clear();
        }
        return false;
    }

    return true;
}

/*
void matrix_scan_user(void) {
    static uint16_t menu_timer = 0;

    if (layer_menu_active) {
        if (menu_timer == 0) {
            menu_timer = timer_read();
        }

        if (timer_elapsed(menu_timer) > 1500) { // 1.5 sec timeout
            layer_menu_active = false;
            active_layer = menu_index;
            layer_move(active_layer);
            oled_clear();
            menu_timer = 0;
        }
    } else {
        menu_timer = 0;
    }
}
*/
/* =======================
 * Encoder logic
 * =======================*/
bool encoder_update_user(uint8_t index, bool clockwise) {

    if (menu_active) {
        // Scroll through layers
        if (clockwise) {
            menu_index = (menu_index + 1) % _NUM_LAYERS;
        } else {
            menu_index = (menu_index + _NUM_LAYERS - 1) % _NUM_LAYERS;
        }
        oled_clear();
        enc_layer = menu_index;
        return false;
    }

    // Normal encoder behavior
    switch (current_layer) {
        case _BASE:
            tap_code(clockwise ? KC_VOLU : KC_VOLD);
            break;
        case _MEDIA:
            tap_code(clockwise ? KC_MNXT : KC_MPRV);
            break;
        case _FN:
            tap_code(clockwise ? KC_PGDN : KC_PGUP);
            break;
       
    }

    return false;
}


/*
bool encoder_update_user(uint8_t index, bool clockwise) {
    switch (get_highest_layer(layer_state)) {
        case _MEDIA:
            if (clockwise) {
                tap_code(KC_MNXT);
            } else {
                tap_code(KC_MPRV);
            }
            break;

        default: // BASE
            if (clockwise) {
                tap_code(KC_VOLU);
            } else {
                tap_code(KC_VOLD);
            }
            break;
    }
    return true;
}
*/


#ifdef OLED_ENABLE
bool oled_task_user(void) {

    oled_set_cursor(0, 0);
    oled_write_ln_P(PSTR("MACROPAD"), false);
    oled_write_ln_P(PSTR("---------"), false);

   if (menu_active) {
        oled_write_ln_P(PSTR("SELECT LAYER"), false);
        oled_write_ln_P(PSTR(""), false);

        oled_write_ln_P(menu_index == _BASE  ? PSTR("> BASE")  : PSTR("  BASE"),  false);
        oled_write_ln_P(menu_index == _MEDIA ? PSTR("> MEDIA") : PSTR("  MEDIA"), false);
        oled_write_ln_P(menu_index == _FN    ? PSTR("> FN")    : PSTR("  FN"),    false);

    } else {
        oled_write_ln_P(PSTR("ACTIVE LAYER"), false);
        oled_write_ln_P(PSTR(""), false);

        switch (current_layer) {
            case _BASE:
                oled_write_ln_P(PSTR("BASE"), false);
                oled_write_ln_P(PSTR("Encoder: VOL"), false);
                break;
            case _MEDIA:
                oled_write_ln_P(PSTR("MEDIA"), false);
                oled_write_ln_P(PSTR("Encoder: TRACK"), false);
                break;
            case _FN:
                oled_write_ln_P(PSTR("FN"), false);
                oled_write_ln_P(PSTR("Custom"), false);
                break;
        }
    }

    return false;
}
#endif
/*
#if OLED_ENABLE
bool oled_task_user(void) {
   // oled_clear();
    static const char image_1 [] PROGMEM = {
	0xff, 0x01, 0x01, 0x01, 0x01, 0x81, 0xc1, 0xe1, 0x71, 0x31, 0x19, 0x19, 0x1d, 0x0d, 0x0d, 0x0d, 
0x0d, 0x0d, 0x0d, 0x1d, 0x19, 0x19, 0x31, 0x71, 0xe1, 0xc1, 0x81, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0x01, 0x01, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 
0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0x01, 0xf1, 0xf1, 0xf1, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x81, 0xc1, 0xe1, 
0x71, 0x31, 0x01, 0x01, 0x01, 0x01, 0xe1, 0xa1, 0xe1, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x00, 0xf0, 0xfc, 0x1f, 0x0f, 0x19, 0x30, 0x60, 0xc0, 0xc0, 0xe0, 0x30, 0x18, 0x0c, 0x0c, 
0x0c, 0x0c, 0x1c, 0x3c, 0xec, 0xcc, 0x0c, 0x0c, 0x0c, 0x0d, 0x0f, 0x1f, 0xfc, 0xe0, 0x00, 0xff, 
0xff, 0x00, 0x00, 0xfe, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xf8, 
0xf0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xe0, 0x38, 0x0c, 0xc4, 0xc6, 0xc2, 0xc2, 0xc6, 0xc4, 0x0c, 0x38, 0xe0, 
0xe0, 0x38, 0x0c, 0xc4, 0xc6, 0xf2, 0xf2, 0xc6, 0xc4, 0x0c, 0x38, 0xe0, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe0, 0xf0, 0x38, 0x1c, 0x0e, 0x07, 0x03, 0x01, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x0f, 0x3f, 0xf8, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0c, 0x18, 0x30, 0xb0, 
0xf0, 0x70, 0x18, 0x0c, 0x07, 0x03, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xf8, 0x3f, 0x07, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x1f, 
0x0f, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x7f, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0c, 0x08, 0x18, 0x10, 0x10, 0x18, 0x08, 0x0c, 0x07, 0x01, 
0x01, 0x07, 0x0c, 0x08, 0x18, 0x13, 0x13, 0x18, 0x08, 0x0c, 0x07, 0x01, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x07, 0x0f, 0x1c, 0x38, 0x70, 0xe0, 0xc0, 0x80, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x80, 0x81, 0x83, 0x87, 0x8e, 0x8c, 0x98, 0x98, 0xbc, 0xb6, 0xb3, 0xb1, 
0xb0, 0xb0, 0xb0, 0xb8, 0x98, 0x98, 0x8c, 0x8e, 0x87, 0x83, 0x81, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 
0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x8f, 0x8f, 0x8f, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x83, 0x87, 
0x8e, 0x8c, 0x80, 0x80, 0x80, 0x80, 0x8f, 0x8f, 0x8f, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
0x01, 0x01, 0x01, 0x81, 0x81, 0x41, 0x41, 0x41, 0x41, 0x81, 0x81, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0x01, 0xf9, 0x09, 0xe9, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 
0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0x29, 0xe9, 0x09, 0xf9, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x81, 0x81, 0x81, 0xc1, 0x41, 0x41, 0x61, 0x21, 0x21, 0x11, 
0x11, 0x21, 0x21, 0x61, 0x41, 0x41, 0xc1, 0x81, 0x81, 0x81, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x01, 0x01, 0xe1, 0x31, 0x51, 0x91, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x19, 0x19, 0x09, 
0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x11, 0x21, 0x41, 0x81, 0x01, 0x01, 0x01, 0x01, 0xff, 
0xff, 0x00, 0x00, 0x00, 0x30, 0x70, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x80, 0x60, 0x3e, 0x61, 0xc0, 0x8c, 0x9e, 0x9e, 0x8c, 0x40, 0x61, 0x1e, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef, 0xe8, 0xe8, 0xe8, 0x08, 0xe8, 0xe8, 0xe8, 0xe8, 0x08, 
0xe8, 0xe8, 0xe8, 0xe8, 0x08, 0xe8, 0xe8, 0xe8, 0xe8, 0xef, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0x01, 0x03, 0xc2, 0xe2, 0x64, 0x24, 0xc4, 0x88, 0x08, 0x08, 0xf0, 
0xf0, 0x08, 0xc8, 0x88, 0x04, 0xc4, 0xc4, 0x02, 0xe2, 0xf1, 0x01, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x01, 0xfe, 0x02, 0x02, 0x02, 0x22, 0xe2, 0xe2, 0xe2, 
0xa2, 0x03, 0x03, 0x01, 0x21, 0x21, 0xe1, 0xe1, 0x21, 0x01, 0x01, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x7e, 0x9c, 0x3c, 0x76, 0x27, 0x89, 
0x78, 0x0c, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xbd, 0xbd, 0xbd, 0xbd, 0x00, 0xbd, 0xbd, 0xbd, 0xbd, 0x00, 
0xbd, 0xbd, 0xbd, 0xbd, 0x00, 0xfd, 0xfd, 0xfd, 0xfd, 0xfd, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x39, 0x73, 0x86, 0xc8, 0x79, 0x71, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x0f, 0xff, 0xf8, 0x0f, 0x0f, 0x78, 0x7f, 0x03, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x01, 
0x03, 0x07, 0x0e, 0x1c, 0x38, 0x70, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x80, 
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x9f, 0x90, 0x97, 0x97, 0x97, 0x97, 0x90, 0x97, 0x97, 0x97, 0x97, 0x90, 
0x97, 0x97, 0x97, 0x97, 0x90, 0x97, 0x97, 0x97, 0x97, 0x97, 0x90, 0x9f, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x82, 0x82, 0x84, 0x84, 0x88, 0x88, 0x90, 0x90, 0xbf, 
0xbf, 0x90, 0x90, 0x88, 0x88, 0x84, 0x84, 0x82, 0x82, 0x81, 0x81, 0x80, 0x80, 0x80, 0x80, 0xff, 
0xff, 0x80, 0x80, 0x80, 0x81, 0x82, 0x84, 0x88, 0x9f, 0x90, 0x90, 0x90, 0x91, 0x91, 0x91, 0x91, 
0x91, 0x90, 0x90, 0x88, 0x88, 0x89, 0x89, 0x89, 0x89, 0x88, 0x88, 0x8f, 0x80, 0x80, 0x80, 0xff
};

    //oled_set_cursor(0, 0);
    //oled_write_P(PSTR("2x4 MACRO"), false);
     static uint8_t last_state = 255;
    uint8_t state = get_highest_layer(layer_state);

    if (state != last_state) {
        oled_clear();
        last_state = state;
    }

    //oled_set_cursor(0, 2);
    switch (get_highest_layer(layer_state)) {
        case _MEDIA:
            oled_write_raw_P(image_1,sizeof(image_1));
            //oled_write_ln_P(PSTR("Layer: MEDIA"), false);
            //oled_write_ln_P(PSTR("Enc: Track"), false);
            break;
        default:
            //oled_clear();
            oled_write_ln_P(PSTR("Layer: BASE"), false);
            oled_write_ln_P(PSTR("Enc: Volume"), false);
            break;
    }

    return false;
}
#endif*/